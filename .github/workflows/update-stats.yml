name: Aggiorna Statistiche README

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Calcola statistiche
      run: |
        # Conta i file
        TOTAL_C=$(find . -name "*.c" -type f | wc -l)
        TOTAL_H=$(find . -name "*.h" -type f | wc -l)
        TOTAL_LINES=$(find . -name "*.c" -type f -exec cat {} \; | wc -l)
        TOTAL_DIRS=$(ls -d */ 2>/dev/null | grep -v ".git" | wc -l)
        
        # Calcola media
        if [ "$TOTAL_C" -gt 0 ]; then
          AVG=$((TOTAL_LINES / TOTAL_C))
        else
          AVG=0
        fi
        
        # Crea la sezione statistiche
        cat > new_stats.md << EOF
        ## ðŸ“Š Statistiche Repository
        
        ![Linguaggio](https://img.shields.io/badge/Linguaggio-C-00599C?style=flat-square)
        ![File C](https://img.shields.io/badge/File%20C-${TOTAL_C}-blue?style=flat-square)
        ![Righe di Codice](https://img.shields.io/badge/Righe-${TOTAL_LINES}-green?style=flat-square)
        
        | Metrica | Valore |
        |---------|--------|
        | ðŸ“„ **File C totali** | ${TOTAL_C} |
        | ðŸ“‹ **File Header (.h)** | ${TOTAL_H} |
        | ðŸ“ **Righe di codice** | ${TOTAL_LINES} |
        | ðŸ“ **Categorie di esercizi** | ${TOTAL_DIRS} |
        | ðŸ“Š **Media righe/file** | ${AVG} |
        
        ### ðŸ“ Distribuzione per categoria
        
        EOF
        
        # Aggiungi la lista delle categorie
        for dir in */; do
          if [ -d "$dir" ] && [ "$dir" != ".git/" ] && [ "$dir" != ".github/" ]; then
            dir_name="${dir%/}"
            c_count=$(find "$dir" -name "*.c" -type f | wc -l)
            if [ "$c_count" -gt 0 ]; then
              echo "- **${dir_name}**: ${c_count} file" >> new_stats.md
            fi
          fi
        done
        
        echo "" >> new_stats.md
        echo "*ðŸ“… Ultimo aggiornamento: $(date '+%d/%m/%Y alle %H:%M') UTC*" >> new_stats.md
    
    - name: Aggiorna README con Python
      run: |
        python3 << 'PYTHON_SCRIPT'
        import re
        
        # Leggi il README
        with open('README.md', 'r', encoding='utf-8') as f:
            readme = f.read()
        
        # Leggi le nuove statistiche
        with open('new_stats.md', 'r', encoding='utf-8') as f:
            new_stats = f.read()
        
        # Pattern per trovare la sezione statistiche
        pattern = r'<!-- STATS_START -->.*?<!-- STATS_END -->'
        replacement = f'<!-- STATS_START -->\n{new_stats}\n<!-- STATS_END -->'
        
        # Sostituisci
        new_readme = re.sub(pattern, replacement, readme, flags=re.DOTALL)
        
        # Scrivi il nuovo README
        with open('README.md', 'w', encoding='utf-8') as f:
            f.write(new_readme)
        
        print("âœ… README aggiornato con successo!")
        PYTHON_SCRIPT
    
    - name: Commit e push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        if git diff --staged --quiet; then
          echo "Nessuna modifica da committare"
        else
          git commit -m "ðŸ“Š Aggiorna statistiche [bot]"
          git push
        fi