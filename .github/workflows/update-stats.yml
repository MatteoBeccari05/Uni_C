name: Update Stats

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate Statistics
      id: stats
      run: |
        echo "Conteggio file in corso..."
        
        # Conta file C
        c_files=$(find . -type f -name "*.c" | grep -v ".git" | wc -l)
        echo "File C trovati: $c_files"
        
        # Conta file H
        h_files=$(find . -type f -name "*.h" | grep -v ".git" | wc -l)
        echo "File H trovati: $h_files"
        
        # Conta righe totali
        total_lines=$(find . -type f -name "*.c" | grep -v ".git" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
        if [ -z "$total_lines" ]; then total_lines=0; fi
        echo "Righe totali: $total_lines"
        
        # Conta cartelle
        folders=$(find . -maxdepth 1 -type d | grep -v "^\.$" | grep -v ".git" | wc -l)
        echo "Cartelle trovate: $folders"
        
        # Calcola media
        if [ $c_files -gt 0 ]; then
          avg=$((total_lines / c_files))
        else
          avg=0
        fi
        echo "Media righe/file: $avg"
        
        # Salva in variabili d'ambiente
        echo "C_FILES=$c_files" >> $GITHUB_ENV
        echo "H_FILES=$h_files" >> $GITHUB_ENV
        echo "TOTAL_LINES=$total_lines" >> $GITHUB_ENV
        echo "FOLDERS=$folders" >> $GITHUB_ENV
        echo "AVG=$avg" >> $GITHUB_ENV
    
    - name: Create Stats Section
      run: |
        cat << 'EOF' > stats.md
        ## ðŸ“Š Statistiche Repository
        
        ![C](https://img.shields.io/badge/Linguaggio-C-00599C?style=flat-square)
        ![Files](https://img.shields.io/badge/File_C-FILES_PLACEHOLDER-blue?style=flat-square)
        ![Lines](https://img.shields.io/badge/Righe-LINES_PLACEHOLDER-green?style=flat-square)
        
        | Metrica | Valore |
        |---------|--------|
        | ðŸ“„ File C totali | FILES_PLACEHOLDER |
        | ðŸ“‹ File Header (.h) | HEADERS_PLACEHOLDER |
        | ðŸ“ Righe di codice | LINES_PLACEHOLDER |
        | ðŸ“ Categorie | FOLDERS_PLACEHOLDER |
        | ðŸ“Š Media righe/file | AVG_PLACEHOLDER |
        
        ### ðŸ“ Distribuzione per categoria
        
        EOF
        
        # Sostituisci i placeholder
        sed -i "s/FILES_PLACEHOLDER/$C_FILES/g" stats.md
        sed -i "s/HEADERS_PLACEHOLDER/$H_FILES/g" stats.md
        sed -i "s/LINES_PLACEHOLDER/$TOTAL_LINES/g" stats.md
        sed -i "s/FOLDERS_PLACEHOLDER/$FOLDERS/g" stats.md
        sed -i "s/AVG_PLACEHOLDER/$AVG/g" stats.md
        
        # Aggiungi distribuzione per categoria
        for dir in */; do
          if [ -d "$dir" ] && [[ "$dir" != ".git/" ]] && [[ "$dir" != ".github/" ]]; then
            name="${dir%/}"
            count=$(find "$dir" -type f -name "*.c" 2>/dev/null | wc -l)
            if [ $count -gt 0 ]; then
              echo "- **$name**: $count file" >> stats.md
            fi
          fi
        done
        
        # Aggiungi timestamp
        echo "" >> stats.md
        echo "*ðŸ“… Aggiornato: $(date '+%d/%m/%Y %H:%M') UTC*" >> stats.md
        
        cat stats.md
    
    - name: Update README
      run: |
        # Backup
        cp README.md README.backup
        
        # Crea script Python per l'aggiornamento
        cat << 'PYSCRIPT' > update.py
        import re
        
        with open('README.md', 'r') as f:
            content = f.read()
        
        with open('stats.md', 'r') as f:
            stats = f.read()
        
        # Cerca e sostituisci tra i marker
        pattern = r'<!-- STATS_START -->.*?<!-- STATS_END -->'
        replacement = f'<!-- STATS_START -->\n{stats}\n<!-- STATS_END -->'
        
        new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
        
        with open('README.md', 'w') as f:
            f.write(new_content)
        
        print("README aggiornato!")
        PYSCRIPT
        
        python3 update.py
        
        # Mostra diff
        echo "=== DIFFERENZE ==="
        git diff README.md || echo "Nessuna differenza"
    
    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add README.md
        
        if git diff --staged --quiet; then
          echo "Nessun cambiamento da committare"
        else
          git commit -m "ðŸ“Š Aggiorna statistiche automatiche"
          git push
          echo "Statistiche aggiornate e pushate!"
        fi