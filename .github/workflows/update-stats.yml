name: Aggiorna Statistiche README

on:
  push:
    branches: [ main, master ]
  schedule:
    # Esegui ogni settimana (domenica alle 00:00)
    - cron: '0 0 * * 0'
  workflow_dispatch: # Permette esecuzione manuale

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Genera statistiche
      run: |
        # Conta file .c
        TOTAL_C=$(find . -name "*.c" -type f | wc -l)
        TOTAL_H=$(find . -name "*.h" -type f | wc -l)
        TOTAL_LINES=$(find . -name "*.c" -type f -exec cat {} \; | wc -l)
        TOTAL_DIRS=$(find . -type d ! -path "*/.git/*" ! -path "./.git" ! -name "." | wc -l)
        
        # Crea la sezione statistiche
        cat > stats_section.md << EOF
        
        ## ðŸ“Š Statistiche Repository
        
        ![Linguaggio](https://img.shields.io/badge/Linguaggio-C-00599C?style=flat-square)
        ![File C](https://img.shields.io/badge/File%20C-${TOTAL_C}-blue?style=flat-square)
        ![Righe di Codice](https://img.shields.io/badge/Righe%20di%20Codice-${TOTAL_LINES}-green?style=flat-square)
        
        | Metrica | Valore |
        |---------|--------|
        | ðŸ“„ **File C totali** | ${TOTAL_C} |
        | ðŸ“‹ **File Header (.h)** | ${TOTAL_H} |
        | ðŸ“ **Righe di codice** | ${TOTAL_LINES} |
        | ðŸ“ **Categorie di esercizi** | ${TOTAL_DIRS} |
        | ðŸ“Š **Media righe/file** | $((TOTAL_LINES / TOTAL_C)) |
        
        ### ðŸ“ Distribuzione per categoria
        
        EOF
        
        # Aggiungi statistiche per categoria
        for dir in */; do
            if [ -d "$dir" ] && [ "$dir" != ".git/" ]; then
                dir_name="${dir%/}"
                c_count=$(find "$dir" -name "*.c" -type f | wc -l)
                if [ $c_count -gt 0 ]; then
                    echo "- **${dir_name}**: ${c_count} file" >> stats_section.md
                fi
            fi
        done
        
        echo "" >> stats_section.md
        echo "*ðŸ“… Ultimo aggiornamento: $(date '+%d/%m/%Y')*" >> stats_section.md
    
    - name: Aggiorna README
      run: |
        # Rimuovi vecchia sezione statistiche se esiste
        sed -i '/## ðŸ“Š Statistiche Repository/,/## ðŸ“Œ Note pratiche/d' README.md
        
        # Inserisci nuove statistiche prima delle "Note pratiche"
        sed -i '/## ðŸ“Œ Note pratiche/r stats_section.md' README.md
        
        rm stats_section.md
    
    - name: Commit e push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add README.md
        git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ“Š Aggiorna statistiche repository [bot]" && git push)